# üöÄ MalianDevs Template Backend

## üìã Table des mati√®res
- [Description](#-description)
- [Architecture du Projet](#-architecture-du-projet)
- [Pr√©requis](#-pr√©requis)
- [Installation](#-installation)
- [Configuration](#-configuration)
- [D√©marrage](#-d√©marrage)
- [Fonctionnalit√©s](#-fonctionnalit√©s)
- [Endpoints API](#-endpoints-api)
- [Exemples CRUD](#-exemples-crud)
- [Comprendre le Projet](#-comprendre-le-projet)
- [Structure des Fichiers](#-structure-des-fichiers)
- [Tests](#-tests)
- [D√©pannage](#-d√©pannage)
[![zread](https://img.shields.io/badge/Ask_Zread-_.svg?style=flat&color=00b0aa&labelColor=000000&logo=data%3Aimage%2Fsvg%2Bxml%3Bbase64%2CPHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTQuOTYxNTYgMS42MDAxSDIuMjQxNTZDMS44ODgxIDEuNjAwMSAxLjYwMTU2IDEuODg2NjQgMS42MDE1NiAyLjI0MDFWNC45NjAxQzEuNjAxNTYgNS4zMTM1NiAxLjg4ODEgNS42MDAxIDIuMjQxNTYgNS42MDAxSDQuOTYxNTZDNS4zMTUwMiA1LjYwMDEgNS42MDE1NiA1LjMxMzU2IDUuNjAxNTYgNC45NjAxVjIuMjQwMUM1LjYwMTU2IDEuODg2NjQgNS4zMTUwMiAxLjYwMDEgNC45NjE1NiAxLjYwMDFaIiBmaWxsPSIjZmZmIi8%2BCjxwYXRoIGQ9Ik00Ljk2MTU2IDEwLjM5OTlIMi4yNDE1NkMxLjg4ODEgMTAuMzk5OSAxLjYwMTU2IDEwLjY4NjQgMS42MDE1NiAxMS4wMzk5VjEzLjc1OTlDMS42MDE1NiAxNC4xMTM0IDEuODg4MSAxNC4zOTk5IDIuMjQxNTYgMTQuMzk5OUg0Ljk2MTU2QzUuMzE1MDIgMTQuMzk5OSA1LjYwMTU2IDE0LjExMzQgNS42MDE1NiAxMy43NTk5VjExLjAzOTlDNS42MDE1NiAxMC42ODY0IDUuMzE1MDIgMTAuMzk5OSA0Ljk2MTU2IDEwLjM5OTlaIiBmaWxsPSIjZmZmIi8%2BCjxwYXRoIGQ9Ik0xMy43NTg0IDEuNjAwMUgxMS4wMzg0QzEwLjY4NSAxLjYwMDEgMTAuMzk4NCAxLjg4NjY0IDEwLjM5ODQgMi4yNDAxVjQuOTYwMUMxMC4zOTg0IDUuMzEzNTYgMTAuNjg1IDUuNjAwMSAxMS4wMzg0IDUuNjAwMUgxMy43NTg0QzE0LjExMTkgNS42MDAxIDE0LjM5ODQgNS4zMTM1NiAxNC4zOTg0IDQuOTYwMVYyLjI0MDFDMTQuMzk4NCAxLjg4NjY0IDE0LjExMTkgMS42MDAxIDEzLjc1ODQgMS42MDAxWiIgZmlsbD0iI2ZmZiIvPgo8cGF0aCBkPSJNNCAxMkwxMiA0TDQgMTJaIiBmaWxsPSIjZmZmIi8%2BCjxwYXRoIGQ9Ik00IDEyTDEyIDQiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8L3N2Zz4K&logoColor=ffffff)](https://zread.ai/MYK-OTAKU/MalianDevs-Template-Backend)
---

## üìñ Description

**MalianDevs Template Backend** est un backend complet, s√©curis√© et modulaire con√ßu pour servir de base universelle √† tous types d'applications m√©tiers (restaurant, √©cole, gaming center, e-commerce, etc.). Il offre une architecture moderne bas√©e sur Node.js, Express et Sequelize.

Ce template est **pr√™t √† l'emploi** et contient toutes les fonctionnalit√©s essentielles pour d√©marrer rapidement un nouveau projet.

### üéØ Points forts
- ‚úÖ **Authentification compl√®te** : JWT, 2FA (authentification √† deux facteurs)
- ‚úÖ **Gestion des r√¥les et permissions** : Syst√®me hi√©rarchique flexible (Administrateur > Manager > Utilisateur)
- ‚úÖ **Audit et monitoring** : Tra√ßage complet des activit√©s utilisateurs
- ‚úÖ **Sessions utilisateur** : Gestion s√©curis√©e des sessions avec tracking IP
- ‚úÖ **Param√®tres dynamiques** : Configuration personnalisable par utilisateur et globale
- ‚úÖ **Architecture SOLID** : Code maintenable, modulaire et √©volutif
- ‚úÖ **Multi-base de donn√©es** : Support PostgreSQL, MySQL, SQLite
- ‚úÖ **Exemples CRUD complets** : Produits (simple) et Commandes (relationnel)
- ‚úÖ **Documentation compl√®te** : Chaque fichier est document√© et expliqu√©
- ‚úÖ **Script de seed** : Initialisation automatique avec admin, r√¥les et permissions

---

## üèóÔ∏è Architecture du Projet

Ce projet suit une architecture **MVC (Model-View-Controller)** avec une s√©paration claire des responsabilit√©s :

```
Backend
‚îÇ
‚îú‚îÄ‚îÄ Models (Mod√®les)      ‚Üí D√©finition de la structure des donn√©es
‚îú‚îÄ‚îÄ Controllers           ‚Üí Logique m√©tier et traitement des requ√™tes
‚îú‚îÄ‚îÄ Services              ‚Üí Logique r√©utilisable et op√©rations complexes
‚îú‚îÄ‚îÄ Routes                ‚Üí D√©finition des endpoints API
‚îú‚îÄ‚îÄ Middlewares           ‚Üí Fonctions interm√©diaires (auth, validation, etc.)
‚îî‚îÄ‚îÄ Utils                 ‚Üí Fonctions utilitaires
```

---

## üîß Pr√©requis

Avant de commencer, assurez-vous d'avoir install√© :

- **Node.js** version 16 ou sup√©rieure ([T√©l√©charger](https://nodejs.org/))
- **npm** ou **yarn** (inclus avec Node.js)
- **PostgreSQL** (optionnel, si vous n'utilisez pas SQLite) ([T√©l√©charger](https://www.postgresql.org/download/))
- Un √©diteur de code (VS Code recommand√©)

---

## üì¶ Installation

### 1Ô∏è‚É£ Cloner le d√©p√¥t

```bash
git clone https://github.com/MYK-OTAKU/MalianDevs-Template-Backend.git
cd MalianDevs-Template-Backend
```

### 2Ô∏è‚É£ Installer les d√©pendances

```bash
npm install
```

Cette commande installe toutes les d√©pendances n√©cessaires list√©es dans `package.json`.

---

## ‚öôÔ∏è Configuration

### 1Ô∏è‚É£ Cr√©er le fichier de configuration

Copiez le fichier d'exemple `.env.example` et renommez-le en `.env` :

```bash
cp .env.example .env
```

### 2Ô∏è‚É£ Configurer les variables d'environnement

Ouvrez le fichier `.env` et modifiez les valeurs selon votre environnement :

#### **Configuration de base**
```env
# Type de base de donn√©es : 'sqlite' ou 'postgres'
DB_TYPE=sqlite

# Port du serveur
PORT=3000

# Environnement : 'development' ou 'production'
NODE_ENV=development

# Configuration JWT (Tokens d'authentification)
JWT_SECRET=votre_cle_secrete_super_longue_et_complexe
JWT_EXPIRES_IN=24h

# CORS - Autoriser les requ√™tes depuis votre frontend
CORS_ORIGIN=http://localhost:5173
```

#### **Option A : SQLite (Base de donn√©es locale - Recommand√© pour d√©buter)**
```env
DB_TYPE=sqlite
SQLITE_PATH=./database.sqlite
```

#### **Option B : PostgreSQL (Production - Neon, Supabase, etc.)**
```env
DB_TYPE=postgres
DATABASE_URL=postgresql://user:password@host:5432/database_name

# OU configuration d√©taill√©e
DB_NAME=dashboard_template_db
DB_USER=votre_username
DB_PASSWORD=votre_password
DB_HOST=localhost
DB_PORT=5432
```

#### **Configuration Email (Optionnel)**
Pour l'envoi d'emails (r√©initialisation de mot de passe, notifications) :
```env
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=votre_email@gmail.com
EMAIL_PASS=votre_mot_de_passe_application
```

---

## üöÄ D√©marrage

### 1Ô∏è‚É£ Initialiser la base de donn√©es

Avant le premier lancement, ex√©cutez le script de seed pour cr√©er l'admin, les r√¥les et permissions :

```bash
npm run seed
```

Vous obtiendrez :
```
üéâ Peuplement termin√© avec succ√®s!

üìã R√©capitulatif:
   - R√¥les: Administrateur, Manager, Utilisateur
   - Permissions: Toutes les permissions de base
   - Admin: admin / Admin123!
```

**Identifiants par d√©faut** :
- Username: `admin`
- Password: `Admin123!`
- Email: `admin@maliandevs.com`

### 2Ô∏è‚É£ Mode d√©veloppement (avec rechargement automatique)

```bash
npm run dev
```

Cette commande d√©marre le serveur avec **nodemon** qui red√©marre automatiquement le serveur √† chaque modification de code.

### 3Ô∏è‚É£ Mode production

```bash
npm start
```

### V√©rifier que le serveur fonctionne

Une fois d√©marr√©, vous devriez voir dans la console :

```
üöÄ [APP] Serveur d√©marr√© avec succ√®s sur http://localhost:3000
‚úÖ [APP] Toutes les initialisations termin√©es
üìä [APP] Application pr√™te √† recevoir des requ√™tes
```

Testez avec :
```bash
curl http://localhost:3000/
```

R√©ponse attendue :
```json
{
  "success": true,
  "message": "üöÄ MalianDevs Template Backend is running successfully",
  "version": "1.0.0",
  "environment": "development"
}
```

---

## ‚ú® Fonctionnalit√©s

### 1. **Authentification et S√©curit√©**
- Inscription et connexion utilisateur
- JWT (JSON Web Tokens) pour l'authentification
- Authentification √† deux facteurs (2FA) avec Google Authenticator
- Gestion s√©curis√©e des sessions
- D√©connexion et invalidation des tokens

### 2. **Gestion des Utilisateurs**
- CRUD complet (Create, Read, Update, Delete)
- Profils utilisateurs
- Activation/D√©sactivation de comptes
- Changement de r√¥les (avec contr√¥le hi√©rarchique)

### 3. **Syst√®me de R√¥les et Permissions**
- R√¥les hi√©rarchiques : Administrateur > Manager > Employ√©
- Permissions granulaires
- Attribution dynamique de permissions aux r√¥les
- Contr√¥le d'acc√®s bas√© sur les r√¥les (RBAC)

### 4. **Monitoring et Audit**
- Logs d'activit√© d√©taill√©s
- Suivi des sessions actives
- Historique des connexions
- Statistiques d'utilisation
- Tra√ßabilit√© compl√®te des actions

### 5. **Param√®tres Dynamiques**
- Configuration globale de l'application
- Pr√©f√©rences utilisateur
- Param√®tres publics et priv√©s

---

## üîå Endpoints API

Tous les endpoints sont pr√©fix√©s par `/api`. Voici la liste compl√®te organis√©e par module :

### üîê Authentification (`/api/auth`)

| M√©thode | Endpoint | Description | Auth requise |
|---------|----------|-------------|--------------|
| `POST` | `/api/auth/login` | Connexion utilisateur | ‚ùå Non |
| `POST` | `/api/auth/verify-2fa` | V√©rification du code 2FA | ‚ùå Non |
| `POST` | `/api/auth/logout` | D√©connexion | ‚úÖ Oui |
| `POST` | `/api/auth/register` | Inscription (admin uniquement) | ‚úÖ Oui + Permission |
| `GET` | `/api/auth/2fa/status` | Statut 2FA de l'utilisateur | ‚úÖ Oui |
| `POST` | `/api/auth/2fa/enable` | Activer le 2FA | ‚úÖ Oui |
| `POST` | `/api/auth/2fa/disable` | D√©sactiver le 2FA | ‚úÖ Oui |
| `POST` | `/api/auth/2fa/regenerate` | R√©g√©n√©rer le secret 2FA | ‚úÖ Oui |

#### Exemples de requ√™tes :

**Connexion**
```bash
POST /api/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "Admin123!"
}

# R√©ponse
{
  "success": true,
  "message": "Connexion r√©ussie",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiresIn": 28800,
    "user": {
      "id": 1,
      "username": "admin",
      "email": "admin@example.com",
      "role": {
        "name": "Administrateur",
        "permissions": ["USERS_ADMIN", "ROLES_VIEW", ...]
      }
    }
  }
}
```

**V√©rification 2FA**
```bash
POST /api/auth/verify-2fa
Content-Type: application/json

{
  "userId": 1,
  "code": "123456"
}
```

---

### üë• Gestion des Utilisateurs (`/api/users`)

| M√©thode | Endpoint | Description | Permission |
|---------|----------|-------------|------------|
| `GET` | `/api/users/profile` | Profil de l'utilisateur connect√© | Authentifi√© |
| `GET` | `/api/users` | Liste de tous les utilisateurs | `USERS_VIEW` |
| `GET` | `/api/users/:id` | D√©tails d'un utilisateur | `USERS_VIEW` |
| `POST` | `/api/users` | Cr√©er un utilisateur | `USERS_ADMIN` |
| `PUT` | `/api/users/:id` | Modifier un utilisateur | `USERS_ADMIN` |
| `DELETE` | `/api/users/:id` | Supprimer un utilisateur | `USERS_ADMIN` |
| `PUT` | `/api/users/:id/activate` | Activer un compte | `USERS_ADMIN` |
| `PUT` | `/api/users/:id/deactivate` | D√©sactiver un compte | `USERS_ADMIN` |
| `POST` | `/api/users/change-role` | Changer le r√¥le d'un utilisateur | `USERS_ADMIN` |

#### Exemples :

**R√©cup√©rer son profil**
```bash
GET /api/users/profile
Authorization: Bearer <votre_token>

# R√©ponse
{
  "success": true,
  "data": {
    "id": 1,
    "username": "admin",
    "firstName": "Admin",
    "lastName": "System",
    "email": "admin@example.com",
    "role": {
      "name": "Administrateur"
    }
  }
}
```

**Cr√©er un utilisateur**
```bash
POST /api/users
Authorization: Bearer <votre_token>
Content-Type: application/json

{
  "username": "nouveau_user",
  "password": "Password123!",
  "firstName": "Jean",
  "lastName": "Dupont",
  "email": "jean@example.com",
  "roleId": 2
}
```

---

### üõ°Ô∏è Gestion des R√¥les (`/api/roles`)

| M√©thode | Endpoint | Description | Permission |
|---------|----------|-------------|------------|
| `GET` | `/api/roles` | Liste des r√¥les | `ROLES_VIEW` |
| `GET` | `/api/roles/:id` | D√©tails d'un r√¥le | `ROLES_VIEW` |
| `GET` | `/api/roles/:id/permissions` | Permissions d'un r√¥le | `ROLES_VIEW` |
| `POST` | `/api/roles` | Cr√©er un r√¥le | Administrateur |
| `PUT` | `/api/roles/:id` | Modifier un r√¥le | Administrateur |
| `DELETE` | `/api/roles/:id` | Supprimer un r√¥le | Administrateur |
| `POST` | `/api/roles/:id/permissions` | Assigner des permissions | Administrateur |

#### Exemple :

**Lister les r√¥les**
```bash
GET /api/roles
Authorization: Bearer <votre_token>

# R√©ponse
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "Administrateur",
      "description": "Acc√®s complet au syst√®me"
    },
    {
      "id": 2,
      "name": "Manager",
      "description": "Gestion d'√©quipe et op√©rations"
    }
  ]
}
```

---

### üîë Gestion des Permissions (`/api/permissions`)

| M√©thode | Endpoint | Description | Permission |
|---------|----------|-------------|------------|
| `GET` | `/api/permissions` | Liste des permissions | `PERMISSIONS_VIEW` |
| `GET` | `/api/permissions/:id` | D√©tails d'une permission | `PERMISSIONS_VIEW` |
| `POST` | `/api/permissions` | Cr√©er une permission | Administrateur |
| `PUT` | `/api/permissions/:id` | Modifier une permission | Administrateur |
| `DELETE` | `/api/permissions/:id` | Supprimer une permission | Administrateur |

---

### üìä Monitoring (`/api/monitoring`)

| M√©thode | Endpoint | Description | Permission |
|---------|----------|-------------|------------|
| `GET` | `/api/monitoring/sessions` | Sessions actives | `ADMIN` |
| `DELETE` | `/api/monitoring/sessions/:sessionId` | Terminer une session | `ADMIN` |
| `GET` | `/api/monitoring/activities` | Logs d'activit√© | `ADMIN` |
| `GET` | `/api/monitoring/activities/stats` | Statistiques d'activit√© | `ADMIN` |
| `GET` | `/api/monitoring/activities/actions` | Actions disponibles | `ADMIN` |
| `GET` | `/api/monitoring/users/:userId/connections` | Historique connexions | `ADMIN` |
| `GET` | `/api/monitoring/users/:userId/activities` | Activit√©s utilisateur | `ADMIN` |
| `GET` | `/api/monitoring/dashboard/stats` | Stats du dashboard | `ADMIN` |

#### Exemple :

**R√©cup√©rer les sessions actives**
```bash
GET /api/monitoring/sessions
Authorization: Bearer <votre_token>

# R√©ponse
{
  "success": true,
  "data": {
    "activeSessions": [
      {
        "id": 1,
        "userId": 1,
        "user": {
          "username": "admin",
          "firstName": "Admin"
        },
        "ipAddress": "127.0.0.1",
        "userAgent": "Mozilla/5.0...",
        "createdAt": "2024-10-06T10:30:00.000Z",
        "isActive": true
      }
    ],
    "total": 1
  }
}
```

---

### ‚öôÔ∏è Param√®tres (`/api/settings`)

| M√©thode | Endpoint | Description | Auth |
|---------|----------|-------------|------|
| `GET` | `/api/settings/public` | Param√®tres publics | ‚ùå Non |
| `GET` | `/api/settings/user/preferences` | Pr√©f√©rences utilisateur | ‚úÖ Oui |
| `PUT` | `/api/settings/user/preferences` | Modifier pr√©f√©rences | ‚úÖ Oui |
| `GET` | `/api/settings/admin/all` | Tous les param√®tres | Admin + Permission |
| `POST` | `/api/settings/admin` | Cr√©er un param√®tre | Admin + Permission |
| `POST` | `/api/settings/admin/bulk` | Cr√©er plusieurs param√®tres | Admin + Permission |
| `PUT` | `/api/settings/admin/:key` | Modifier un param√®tre | Admin + Permission |
| `DELETE` | `/api/settings/admin/:key` | Supprimer un param√®tre | Admin + Permission |

### üì¶ Gestion des Cat√©gories (`/api/categories`)

| M√©thode | Endpoint | Description | Permission |
|---------|----------|-------------|------------|
| `GET` | `/api/categories` | Liste des cat√©gories | `CATEGORIES_VIEW` |
| `GET` | `/api/categories/:id` | D√©tails d'une cat√©gorie | `CATEGORIES_VIEW` |
| `POST` | `/api/categories` | Cr√©er une cat√©gorie | `CATEGORIES_CREATE` |
| `PUT` | `/api/categories/:id` | Modifier une cat√©gorie | `CATEGORIES_UPDATE` |
| `DELETE` | `/api/categories/:id` | Supprimer une cat√©gorie | `CATEGORIES_DELETE` |
| `PATCH` | `/api/categories/:id/toggle` | Activer/D√©sactiver | `CATEGORIES_UPDATE` |
| `PUT` | `/api/categories/reorder` | R√©organiser l'ordre | `CATEGORIES_UPDATE` |

#### Exemples :

**Lister les cat√©gories**
```bash
GET /api/categories
Authorization: Bearer <votre_token>

# R√©ponse
{
  "success": true,
  "data": {
    "categories": [
      {
        "id": 1,
        "name": "√âlectronique",
        "description": "Appareils √©lectroniques",
        "icon": "üì±",
        "color": "#3B82F6",
        "isActive": true,
        "productsCount": 15
      }
    ],
    "pagination": {
      "total": 5,
      "page": 1,
      "totalPages": 1
    }
  }
}
```

### üõçÔ∏è Gestion des Produits (`/api/products`)

| M√©thode | Endpoint | Description | Permission |
|---------|----------|-------------|------------|
| `GET` | `/api/products` | Liste des produits | `PRODUCTS_VIEW` |
| `GET` | `/api/products/:id` | D√©tails d'un produit | `PRODUCTS_VIEW` |
| `POST` | `/api/products` | Cr√©er un produit | `PRODUCTS_CREATE` |
| `PUT` | `/api/products/:id` | Modifier un produit | `PRODUCTS_UPDATE` |
| `DELETE` | `/api/products/:id` | Supprimer un produit | `PRODUCTS_DELETE` |
| `PATCH` | `/api/products/:id/stock` | Mettre √† jour le stock | `PRODUCTS_UPDATE` |

---

## üéì Exemples CRUD

Le template inclut trois exemples complets de CRUD pour vous aider √† comprendre comment impl√©menter vos propres fonctionnalit√©s.

### üì¶ Exemple 1 : Categories (CRUD Simple)

Cet exemple montre un CRUD complet basique avec toutes les op√©rations standards pour la gestion des cat√©gories.

**Endpoints disponibles** :
- `GET /api/categories` - Liste toutes les cat√©gories (avec pagination, filtres)
- `GET /api/categories/:id` - R√©cup√®re une cat√©gorie
- `POST /api/categories` - Cr√©e une cat√©gorie
- `PUT /api/categories/:id` - Modifie une cat√©gorie
- `DELETE /api/categories/:id` - Supprime une cat√©gorie
- `PATCH /api/categories/:id/toggle` - Active/d√©sactive une cat√©gorie
- `PUT /api/categories/reorder` - R√©organise l'ordre des cat√©gories

**Fichiers concern√©s** :
- Model : `models/Category.js`
- Controller : `controllers/CategoryController.js`
- Routes : `routes/CategoryRoutes.js`

**Exemple de cr√©ation de cat√©gorie** :
```bash
POST /api/categories
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "√âlectronique",
  "description": "Appareils √©lectroniques et gadgets",
  "icon": "üì±",
  "color": "#3B82F6",
  "isActive": true
}
```

### üõçÔ∏è Exemple 2 : Products (CRUD Relationnel)

Cet exemple montre un CRUD avec relations (Product ‚Üí Category) et gestion avanc√©e.

**Endpoints disponibles** :
- `GET /api/products` - Liste tous les produits (avec pagination, filtres)
- `GET /api/products/:id` - R√©cup√®re un produit
- `POST /api/products` - Cr√©e un produit
- `PUT /api/products/:id` - Modifie un produit
- `DELETE /api/products/:id` - Supprime un produit
- `PATCH /api/products/:id/stock` - Met √† jour le stock

**Fichiers concern√©s** :
- Model : `models/Product.js`
- Service : `services/ProductService.js`
- Controller : `controllers/ProductController.js`
- Routes : `routes/ProductRoutes.js`

**Exemple de cr√©ation de produit** :
```bash
POST /api/products
Authorization: Bearer <token>
Content-Type: application/json

{
  "name": "iPhone 15 Pro",
  "description": "Smartphone Apple derni√®re g√©n√©ration",
  "price": 1199.99,
  "stock": 25,
  "categoryId": 1,
  "imageUrl": "https://example.com/iphone15.jpg",
  "isActive": true
}
```

### üõí Exemple 3 : Orders (CRUD Relationnel)

Cet exemple montre un CRUD avec relations (Order ‚Üí OrderItems ‚Üí Products).
D√©montre comment g√©rer des entit√©s li√©es avec transactions.

**Endpoints disponibles** :
- `GET /api/orders` - Liste toutes les commandes (avec produits inclus)
- `GET /api/orders/:id` - R√©cup√®re une commande d√©taill√©e
- `POST /api/orders` - Cr√©e une commande avec produits
- `PATCH /api/orders/:id/status` - Change le statut
- `DELETE /api/orders/:id` - Supprime une commande
- `GET /api/orders/user/my-orders` - Mes commandes

**Fichiers concern√©s** :
- Models : `models/Order.js`, `models/OrderItem.js`
- Service : `services/OrderService.js`
- Controller : `controllers/OrderController.js`
- Routes : `routes/OrderRoutes.js`

**Exemple de cr√©ation de commande** :
```bash
POST /api/orders
Authorization: Bearer <token>
Content-Type: application/json

{
  "items": [
    {
      "productId": "uuid-du-produit-1",
      "quantity": 2
    },
    {
      "productId": "uuid-du-produit-2",
      "quantity": 1
    }
  ],
  "notes": "Livraison express"
}
```

**Caract√©ristiques du CRUD Order** :
- Gestion automatique du stock produit
- Calcul automatique du total
- G√©n√©ration de num√©ro de commande unique
- Gestion des statuts (pending, confirmed, processing, shipped, delivered, cancelled)
- Restauration du stock en cas d'annulation
- Inclusions automatiques (user, products) dans les r√©ponses

### üîß Comment utiliser ces exemples

Ces exemples sont **compl√®tement fonctionnels** et **prot√©g√©s par permissions**. Vous pouvez :

1. **Les utiliser tels quels** dans votre application
2. **Les dupliquer** pour cr√©er de nouvelles entit√©s similaires
3. **Les √©tudier** pour comprendre les patterns utilis√©s
4. **Les modifier** selon vos besoins sp√©cifiques

**Pour cr√©er une nouvelle entit√© bas√©e sur ces exemples** :
1. Copiez les fichiers (model, service, controller, routes)
2. Remplacez les noms (Product ‚Üí YourEntity)
3. Ajoutez les permissions dans `utils/permissionsInit.js`
4. Enregistrez les routes dans `app.js`
5. Ex√©cutez `npm run seed` pour cr√©er les permissions

---

## üìö Comprendre le Projet

Cette section explique en d√©tail chaque composant du projet pour les d√©butants.

### üóÇÔ∏è Models (Mod√®les)

Les **models** d√©finissent la structure de vos donn√©es et comment elles sont stock√©es dans la base de donn√©es.

**Localisation** : `/models/`

#### Mod√®les disponibles :

1. **User.js** - Utilisateurs
   - Contient : username, password, email, firstName, lastName, roleId, etc.
   - Relation : Un utilisateur appartient √† un r√¥le

2. **Role.js** - R√¥les
   - Contient : name, description
   - Exemple : "Administrateur", "Manager", "Employ√©"

3. **Permission.js** - Permissions
   - Contient : name, description
   - Exemple : "USERS_VIEW", "USERS_ADMIN", "ROLES_VIEW"

4. **RolePermission.js** - Table de liaison
   - Relie les r√¥les aux permissions (relation many-to-many)

5. **UserSession.js** - Sessions utilisateur
   - Suit les connexions : token, ipAddress, userAgent, isActive

6. **ActivityLog.js** - Logs d'activit√©
   - Enregistre toutes les actions : action, userId, resourceType, details

7. **Settings.js** - Param√®tres
   - Configuration dynamique : key, value, type, scope

**Exemple simple** :
```javascript
// Un mod√®le User simplifi√©
{
  id: 1,
  username: "john_doe",
  email: "john@example.com",
  roleId: 2, // R√©f√©rence au r√¥le
  isActive: true
}
```

---

### üéÆ Controllers (Contr√¥leurs)

Les **controllers** contiennent la logique m√©tier. Ils traitent les requ√™tes HTTP, appellent les services si n√©cessaire, et retournent les r√©ponses.

**Localisation** : `/controllers/`

#### Contr√¥leurs disponibles :

1. **AuthController.js** - Authentification
   - `login()` : V√©rifie les identifiants et g√©n√®re un token JWT
   - `register()` : Cr√©e un nouveau compte
   - `logout()` : Invalide la session
   - `enableTwoFactor()` : Active le 2FA
   - `verifyTwoFactor()` : V√©rifie le code 2FA

2. **userController.js** - Gestion utilisateurs
   - `getAllUsers()` : Liste tous les utilisateurs
   - `getUserById()` : R√©cup√®re un utilisateur sp√©cifique
   - `createUser()` : Cr√©e un utilisateur
   - `updateUser()` : Modifie un utilisateur
   - `deleteUser()` : Supprime un utilisateur
   - `changeUserRole()` : Change le r√¥le

3. **RoleController.js** - Gestion des r√¥les
   - `getAllRoles()` : Liste les r√¥les
   - `createRole()` : Cr√©e un r√¥le
   - `assignPermissionsToRole()` : Assigne des permissions

4. **PermissionController.js** - Gestion des permissions
   - CRUD complet des permissions

5. **MonitoringController.js** - Surveillance
   - `getActiveSessions()` : Sessions actives
   - `getActivityLogs()` : Logs d'activit√©
   - `getUserConnectionHistory()` : Historique des connexions

6. **SettingsController.js** - Param√®tres
   - `getPublicSettings()` : Param√®tres publics
   - `getUserPreferences()` : Pr√©f√©rences utilisateur
   - `updateSetting()` : Modifier un param√®tre

**Comment √ßa fonctionne** :
```javascript
// Exemple simplifi√© d'un controller
async login(req, res) {
  // 1. R√©cup√©rer les donn√©es de la requ√™te
  const { username, password } = req.body;
  
  // 2. Appeler le service pour la logique m√©tier
  const result = await AuthService.login(username, password);
  
  // 3. Retourner la r√©ponse
  return res.status(200).json({
    success: true,
    data: result
  });
}
```

---

### üîß Services

Les **services** contiennent la logique m√©tier complexe et r√©utilisable. Ils sont appel√©s par les controllers.

**Localisation** : `/services/`

#### Services disponibles :

1. **AuthService.js** - Service d'authentification
   - Logique de connexion, validation des mots de passe
   - G√©n√©ration et v√©rification des tokens JWT
   - Gestion du 2FA (g√©n√©ration de secrets, QR codes)
   - Hachage s√©curis√© des mots de passe avec bcrypt

2. **AuditService.js** - Service d'audit
   - Enregistrement des activit√©s dans ActivityLog
   - Cr√©ation et gestion des sessions utilisateur
   - Nettoyage des sessions inactives
   - Tra√ßabilit√© compl√®te des actions

3. **NotificationService.js** - Service de notifications
   - Envoi de notifications (√† d√©velopper)
   - Gestion des emails

**Principe de s√©paration** :
- **Controller** : G√®re la requ√™te HTTP
- **Service** : Contient la logique m√©tier
- **Model** : Structure les donn√©es

**Exemple** :
```javascript
// Service AuthService
class AuthService {
  static async login(username, password, ipAddress, userAgent) {
    // 1. Chercher l'utilisateur
    const user = await User.findOne({ where: { username } });
    
    // 2. V√©rifier le mot de passe
    const isValidPassword = await bcrypt.compare(password, user.password);
    
    // 3. G√©n√©rer le token JWT
    const token = generateToken({ userId: user.id });
    
    // 4. Cr√©er la session
    await AuditService.createSession(user.id, token, ipAddress, userAgent);
    
    return { token, user };
  }
}
```

---

### üõ£Ô∏è Routes

Les **routes** d√©finissent les endpoints de votre API et les associent aux controllers.

**Localisation** : `/routes/`

**Structure d'une route** :
```javascript
// Exemple de AuthRoutes.js
const express = require('express');
const router = express.Router();
const AuthController = require('../controllers/AuthController');
const { authenticate } = require('../middlewares/auth');

// Route publique (pas d'auth requise)
router.post('/login', AuthController.login);

// Route prot√©g√©e (auth requise)
router.post('/logout', authenticate, AuthController.logout);

module.exports = router;
```

**Middlewares sur les routes** :
- `authenticate` : V√©rifie que l'utilisateur est connect√©
- `hasPermission('USERS_VIEW')` : V√©rifie une permission sp√©cifique
- `hasRole('Administrateur')` : V√©rifie un r√¥le sp√©cifique

---

### üîê Middlewares

Les **middlewares** sont des fonctions qui s'ex√©cutent entre la requ√™te et le controller.

**Localisation** : `/middlewares/`

#### Middlewares disponibles :

1. **auth.js** - Authentification
   - `authenticate` : V√©rifie le token JWT
   - `hasPermission(permission)` : V√©rifie une permission
   - `hasRole(role)` : V√©rifie un r√¥le
   - `canManageUser()` : V√©rifie la hi√©rarchie des r√¥les

2. **audit.js** - Audit
   - `trackUserSession` : Enregistre les activit√©s
   - `logResourceActivity(resourceType)` : Log les actions sur une ressource

3. **sessionCheck.js** - V√©rification de session
   - `checkActiveSession` : V√©rifie que la session est active

4. **permissions.js** - Permissions
   - `checkPermission(permission)` : Alternative pour v√©rifier les permissions

5. **cors.js** - CORS
   - Configure les origines autoris√©es pour les requ√™tes

6. **responseSanitizer.js** - Nettoyage des r√©ponses
   - Supprime les donn√©es sensibles des r√©ponses

**Flux d'une requ√™te avec middlewares** :
```
Requ√™te HTTP
    ‚Üì
[cors] - V√©rifie l'origine
    ‚Üì
[authenticate] - V√©rifie le token
    ‚Üì
[hasPermission] - V√©rifie la permission
    ‚Üì
[Controller] - Traite la requ√™te
    ‚Üì
[responseSanitizer] - Nettoie la r√©ponse
    ‚Üì
R√©ponse HTTP
```

---

### üõ†Ô∏è Utils (Utilitaires)

Les **utils** contiennent des fonctions utilitaires r√©utilisables.

**Localisation** : `/utils/`

#### Utilitaires disponibles :

1. **errorHandler.js** - Gestion des erreurs
   - Classe `AppError` pour les erreurs personnalis√©es
   - `ErrorTypes` : Erreurs standardis√©es avec codes
   - `errorMiddleware` : Middleware de gestion d'erreurs

2. **responseHandler.js** - Standardisation des r√©ponses
   - Format uniforme pour toutes les r√©ponses API

3. **jwt.js** - JWT
   - `generateToken(payload)` : G√©n√®re un token JWT
   - `verifyToken(token)` : V√©rifie et d√©code un token

4. **permissionsInit.js** - Initialisation
   - `initDefaultRolesAndPermissions()` : Cr√©e les r√¥les et permissions par d√©faut

5. **dataSanitizer.js** - Nettoyage des donn√©es
   - Supprime les donn√©es sensibles avant envoi

---

### ‚öôÔ∏è Configuration

**Localisation** : `/config/`

1. **sequelize.js** - Configuration de la base de donn√©es
   - Connexion PostgreSQL ou SQLite
   - Export de l'instance Sequelize

2. **jwt.js** - Configuration JWT
   - Secret et dur√©e d'expiration des tokens

---

## üìÇ Structure des Fichiers

```
MalianDevs-Template-Backend/
‚îÇ
‚îú‚îÄ‚îÄ üìÅ config/              # Configuration (DB, JWT, etc.)
‚îÇ   ‚îú‚îÄ‚îÄ sequelize.js
‚îÇ   ‚îî‚îÄ‚îÄ jwt.js
‚îÇ
‚îú‚îÄ‚îÄ üìÅ controllers/         # Contr√¥leurs (logique m√©tier)
‚îÇ   ‚îú‚îÄ‚îÄ AuthController.js
‚îÇ   ‚îú‚îÄ‚îÄ userController.js
‚îÇ   ‚îú‚îÄ‚îÄ RoleController.js
‚îÇ   ‚îú‚îÄ‚îÄ PermissionController.js
‚îÇ   ‚îú‚îÄ‚îÄ CategoryController.js
‚îÇ   ‚îú‚îÄ‚îÄ ProductController.js
‚îÇ   ‚îú‚îÄ‚îÄ OrderController.js
‚îÇ   ‚îú‚îÄ‚îÄ MonitoringController.js
‚îÇ   ‚îî‚îÄ‚îÄ SettingsController.js
‚îÇ
‚îú‚îÄ‚îÄ üìÅ models/              # Mod√®les de donn√©es (Sequelize)
‚îÇ   ‚îú‚îÄ‚îÄ User.js
‚îÇ   ‚îú‚îÄ‚îÄ Role.js
‚îÇ   ‚îú‚îÄ‚îÄ Permission.js
‚îÇ   ‚îú‚îÄ‚îÄ RolePermission.js
‚îÇ   ‚îú‚îÄ‚îÄ UserSession.js
‚îÇ   ‚îú‚îÄ‚îÄ ActivityLog.js
‚îÇ   ‚îú‚îÄ‚îÄ Settings.js
‚îÇ   ‚îú‚îÄ‚îÄ Category.js
‚îÇ   ‚îú‚îÄ‚îÄ Product.js
‚îÇ   ‚îú‚îÄ‚îÄ Order.js
‚îÇ   ‚îú‚îÄ‚îÄ OrderItem.js
‚îÇ   ‚îî‚îÄ‚îÄ index.js
‚îÇ
‚îú‚îÄ‚îÄ üìÅ routes/              # Routes API
‚îÇ   ‚îú‚îÄ‚îÄ AuthRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ userRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ RoleRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ PermissionRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ CategoryRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ ProductRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ OrderRoutes.js
‚îÇ   ‚îú‚îÄ‚îÄ MonitoringRoutes.js
‚îÇ   ‚îî‚îÄ‚îÄ SettingsRoutes.js
‚îÇ
‚îú‚îÄ‚îÄ üìÅ services/            # Services (logique r√©utilisable)
‚îÇ   ‚îú‚îÄ‚îÄ AuthService.js
‚îÇ   ‚îú‚îÄ‚îÄ AuditService.js
‚îÇ   ‚îî‚îÄ‚îÄ NotificationService.js
‚îÇ
‚îú‚îÄ‚îÄ üìÅ middlewares/         # Middlewares (auth, validation, etc.)
‚îÇ   ‚îú‚îÄ‚îÄ auth.js
‚îÇ   ‚îú‚îÄ‚îÄ audit.js
‚îÇ   ‚îú‚îÄ‚îÄ sessionCheck.js
‚îÇ   ‚îú‚îÄ‚îÄ permissions.js
‚îÇ   ‚îú‚îÄ‚îÄ cors.js
‚îÇ   ‚îî‚îÄ‚îÄ responseSanitizer.js
‚îÇ
‚îú‚îÄ‚îÄ üìÅ utils/               # Fonctions utilitaires
‚îÇ   ‚îú‚îÄ‚îÄ errorHandler.js
‚îÇ   ‚îú‚îÄ‚îÄ responseHandler.js
‚îÇ   ‚îú‚îÄ‚îÄ jwt.js
‚îÇ   ‚îú‚îÄ‚îÄ dataSanitizer.js
‚îÇ   ‚îî‚îÄ‚îÄ permissionsInit.js
‚îÇ
‚îú‚îÄ‚îÄ üìÅ migrations/          # Migrations de base de donn√©es
‚îú‚îÄ‚îÄ üìÅ tests/               # Tests unitaires et d'int√©gration
‚îú‚îÄ‚îÄ üìÅ scripts/             # Scripts utilitaires
‚îÇ
‚îú‚îÄ‚îÄ üìÑ app.js               # Point d'entr√©e de l'application
‚îú‚îÄ‚îÄ üìÑ initAndStart.js      # Script d'initialisation
‚îú‚îÄ‚îÄ üìÑ package.json         # D√©pendances et scripts
‚îú‚îÄ‚îÄ üìÑ .env.example         # Exemple de configuration
‚îú‚îÄ‚îÄ üìÑ .gitignore           # Fichiers √† ignorer par Git
‚îî‚îÄ‚îÄ üìÑ README.md            # Ce fichier
```

---

## üß™ Tests

Le projet utilise **Jest** pour les tests.

### Ex√©cuter les tests

```bash
# Tous les tests
npm test

# Tests avec surveillance (rerun automatique)
npm run test:watch

# Tests avec couverture de code
npm run test:coverage
```

### Structure des tests

Les tests sont dans le dossier `/tests/` et suivent la m√™me structure que le code source.

---

## üêõ D√©pannage

### Probl√®me : "Module not found"

**Solution** : R√©installez les d√©pendances
```bash
rm -rf node_modules
npm install
```

### Probl√®me : "Cannot connect to database"

**Solutions** :
1. V√©rifiez votre fichier `.env`
2. Pour PostgreSQL : V√©rifiez que la base de donn√©es existe
3. Pour SQLite : V√©rifiez les permissions d'√©criture

### Probl√®me : "JWT Secret not configured"

**Solution** : Ajoutez `JWT_SECRET` dans votre `.env`
```env
JWT_SECRET=votre_cle_secrete_super_longue_et_complexe
```

### Probl√®me : Port d√©j√† utilis√©

**Solution** : Changez le port dans `.env`
```env
PORT=3001
```

Ou arr√™tez le processus qui utilise le port :
```bash
# Windows
netstat -ano | findstr :3000
taskkill /PID <PID> /F

# Linux/Mac
lsof -ti:3000 | xargs kill -9
```

### Probl√®me : "Permission denied" sur les routes

**Solution** : V√©rifiez que :
1. Votre token est valide
2. Votre r√¥le a les permissions n√©cessaires
3. Le header Authorization est bien pr√©sent : `Bearer <token>`

---

## üìû Support

Pour toute question ou probl√®me :
- Ouvrez une issue sur GitHub
- Consultez la documentation des d√©pendances
- V√©rifiez les logs dans la console

---

## ü§ù Contribution

Les contributions sont les bienvenues ! Pour contribuer :

1. Forkez le projet
2. Cr√©ez une branche (`git checkout -b feature/nouvelle-fonctionnalite`)
3. Commitez vos changements (`git commit -m 'Ajout nouvelle fonctionnalit√©'`)
4. Pushez vers la branche (`git push origin feature/nouvelle-fonctionnalite`)
5. Ouvrez une Pull Request

---

## üìÑ Licence

ISC License

---

## üéì Concepts Cl√©s pour D√©butants

### Qu'est-ce qu'une API REST ?

Une **API REST** (Representational State Transfer) est une interface qui permet √† des applications de communiquer entre elles via HTTP.

**Principes** :
- **Ressources** : Utilisateurs, R√¥les, etc.
- **M√©thodes HTTP** :
  - `GET` : R√©cup√©rer des donn√©es
  - `POST` : Cr√©er des donn√©es
  - `PUT` : Modifier des donn√©es
  - `DELETE` : Supprimer des donn√©es
- **Stateless** : Chaque requ√™te est ind√©pendante
- **JSON** : Format d'√©change de donn√©es

### Qu'est-ce que JWT ?

**JWT (JSON Web Token)** est un standard pour cr√©er des tokens d'authentification.

**Structure** : `header.payload.signature`

**Exemple** :
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEsImlhdCI6MTYzMDAwMDAwMH0.signature
```

**Utilisation** :
1. L'utilisateur se connecte avec username/password
2. Le serveur g√©n√®re un JWT
3. Le client envoie le JWT dans le header `Authorization: Bearer <token>`
4. Le serveur v√©rifie le JWT pour chaque requ√™te

### Qu'est-ce que le 2FA ?

**2FA (Two-Factor Authentication)** ajoute une couche de s√©curit√© en demandant un code temporaire en plus du mot de passe.

**Fonctionnement** :
1. L'utilisateur active le 2FA
2. Un QR code est g√©n√©r√© (√† scanner avec Google Authenticator)
3. √Ä chaque connexion, l'utilisateur doit entrer le code √† 6 chiffres

### Qu'est-ce que Sequelize ?

**Sequelize** est un ORM (Object-Relational Mapping) pour Node.js.

**Avantages** :
- √âcrire du JavaScript au lieu de SQL
- Gestion automatique des relations
- Support de plusieurs bases de donn√©es

**Exemple** :
```javascript
// Au lieu de SQL : SELECT * FROM users WHERE id = 1
const user = await User.findByPk(1);
```

### Qu'est-ce que les Middlewares ?

Les **middlewares** sont des fonctions qui s'ex√©cutent avant ou apr√®s le traitement d'une requ√™te.

**Exemple** :
```javascript
// Middleware d'authentification
const authenticate = (req, res, next) => {
  // V√©rifier le token
  if (!token) {
    return res.status(401).json({ error: 'Non authentifi√©' });
  }
  // Continuer vers le controller
  next();
};
```

---

## üöÄ Aller Plus Loin

### Am√©liorations possibles

1. **Notifications en temps r√©el** avec Socket.io
2. **Upload de fichiers** (photos de profil)
3. **R√©initialisation de mot de passe** par email
4. **Rate limiting** pour pr√©venir les attaques
5. **Pagination** sur les listes
6. **Filtres avanc√©s** sur les requ√™tes
7. **Exports** (CSV, PDF) des donn√©es

### Ressources d'apprentissage

- [Node.js Documentation](https://nodejs.org/docs/)
- [Express.js Guide](https://expressjs.com/fr/)
- [Sequelize Documentation](https://sequelize.org/)
- [JWT.io](https://jwt.io/)
- [REST API Best Practices](https://restfulapi.net/)

---

**D√©velopp√© avec ‚ù§Ô∏è par MalianDevs**

